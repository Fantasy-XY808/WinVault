<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="WinVault.Pages.CommandQueryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:converters="using:WinVault.Converters"
    xmlns:local="using:WinVault.Pages"
    xmlns:animations="using:Microsoft.Toolkit.Uwp.UI.Animations">
    <Page.Resources>
        <converters:BooleanNegationConverter x:Key="BooleanNegationConverter" />
        
        <!-- 动画资源 -->
        <Storyboard x:Name="FadeInStoryboard">
            <DoubleAnimation
                Storyboard.TargetName="CommandOutputText"
                Storyboard.TargetProperty="Opacity"
                From="0.0" To="1.0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <CircleEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- 性能优化：使用缓存模式 -->
        <x:Double x:Key="DisabledOpacity">0.5</x:Double>
        
        <!-- 按钮样式 -->
        <Style x:Key="ModernButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Background" Value="{ThemeResource ButtonBackground}" />
            <Setter Property="BorderBrush" Value="{ThemeResource ButtonBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="UseSystemFocusVisuals" Value="True" />
            <Setter Property="CacheMode" Value="BitmapCache" />
        </Style>
        
        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Background" Value="{ThemeResource AccentButtonBackground}" />
            <Setter Property="Foreground" Value="{ThemeResource AccentButtonForeground}" />
            <Setter Property="UseSystemFocusVisuals" Value="True" />
            <Setter Property="CacheMode" Value="BitmapCache" />
        </Style>
        
        <Style x:Key="SecondaryButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="16,8" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="UseSystemFocusVisuals" Value="True" />
            <Setter Property="CacheMode" Value="BitmapCache" />
        </Style>
        
        <!-- 列表项样式 -->
        <Style x:Key="CommandItemStyle" TargetType="ListViewItem">
            <Setter Property="Margin" Value="0,4,0,4" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Background" Value="{ThemeResource ButtonBackground}" />
            <Setter Property="BorderBrush" Value="{ThemeResource ButtonBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="CacheMode" Value="BitmapCache" />
        </Style>
        
        <!-- 卡片容器样式 -->
        <Style x:Key="ModernCardStyle" TargetType="Grid">
            <Setter Property="Background" Value="{ThemeResource SolidBackgroundFillColorBase}" />
            <Setter Property="BorderBrush" Value="{ThemeResource ButtonBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="CacheMode" Value="BitmapCache" />
        </Style>
    </Page.Resources>
    
    <Grid Padding="16" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState x:Name="WideState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="800" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="LeftColumnDefinition.Width" Value="280" />
                        <Setter Target="RightColumnDefinition.Width" Value="*" />
                        <Setter Target="LeftPanel.Margin" Value="0,0,16,0" />
                        <Setter Target="RightPanelContainer.Margin" Value="0" />
                        <Setter Target="LeftPanel.Grid.Column" Value="0" />
                        <Setter Target="RightPanelContainer.Grid.Column" Value="1" />
                        <Setter Target="RightPanelContainer.Grid.Row" Value="0" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="MediumState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="LeftColumnDefinition.Width" Value="240" />
                        <Setter Target="RightColumnDefinition.Width" Value="*" />
                        <Setter Target="LeftPanel.Margin" Value="0,0,16,0" />
                        <Setter Target="RightPanelContainer.Margin" Value="0" />
                        <Setter Target="LeftPanel.Grid.Column" Value="0" />
                        <Setter Target="RightPanelContainer.Grid.Column" Value="1" />
                        <Setter Target="RightPanelContainer.Grid.Row" Value="0" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="NarrowState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContentGrid.ColumnDefinitions[0].Width" Value="*" />
                        <Setter Target="MainContentGrid.ColumnDefinitions[1].Width" Value="0" />
                        <Setter Target="LeftPanel.Grid.Column" Value="0" />
                        <Setter Target="LeftPanel.Grid.ColumnSpan" Value="2" />
                        <Setter Target="LeftPanel.Margin" Value="0,0,0,16" />
                        <Setter Target="LeftPanel.Height" Value="350" />
                        <Setter Target="RightPanelContainer.Grid.Row" Value="1" />
                        <Setter Target="RightPanelContainer.Grid.Column" Value="0" />
                        <Setter Target="RightPanelContainer.Grid.ColumnSpan" Value="2" />
                        <Setter Target="RightPanelContainer.Margin" Value="0" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        
        <!-- 搜索栏 -->
        <AutoSuggestBox 
            Grid.Row="0"
            x:Name="SearchBox" 
            Width="Auto"
            MinWidth="240"
            HorizontalAlignment="Stretch"
            PlaceholderText="搜索命令名称、功能或描述..."
            QuerySubmitted="SearchBox_QuerySubmitted"
            TextChanged="SearchBox_TextChanged"
            VerticalAlignment="Center"
            Margin="0,0,0,16">
            <AutoSuggestBox.QueryIcon>
                <FontIcon Glyph="&#xE721;" />
            </AutoSuggestBox.QueryIcon>
        </AutoSuggestBox>
        
        <!-- 主内容区域 -->
        <Grid Grid.Row="1" x:Name="MainContentGrid" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftColumnDefinition" Width="300" MinWidth="240" />
                <ColumnDefinition x:Name="RightColumnDefinition" Width="*" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            
            <!-- 左侧面板：分类和命令列表 -->
            <Grid x:Name="LeftPanel" Grid.Column="0" Grid.Row="0" Margin="0,0,16,0" VerticalAlignment="Stretch">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- 分类选择区域 -->
                <ComboBox 
                    x:Name="CategoryComboBox" 
                    Grid.Row="0"
                    HorizontalAlignment="Stretch"
                    Margin="0,0,0,12"
                    SelectedIndex="0"
                    SelectionChanged="CategoryComboBox_SelectionChanged"
                    CornerRadius="4"
                    Padding="10,6">
                    <ComboBoxItem Content="全部命令" />
                    <ComboBoxItem Content="系统" />
                    <ComboBoxItem Content="网络" />
                    <ComboBoxItem Content="磁盘" />
                    <ComboBoxItem Content="安全" />
                    <ComboBoxItem Content="服务" />
                    <ComboBoxItem Content="驱动" />
                    <ComboBoxItem Content="硬件" />
                    <ComboBoxItem Content="日志" />
                    <ComboBoxItem Content="用户" />
                    <ComboBoxItem Content="文件" />
                    <ComboBoxItem Content="优化" />
                    <ComboBoxItem Content="故障排除" />
                    <ComboBoxItem Content="其他" />
                </ComboBox>
                
                <!-- 命令列表 -->
                <Border Grid.Row="1" BorderThickness="1" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" CornerRadius="8" Padding="4">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollMode="Auto" HorizontalScrollMode="Disabled"
                                  ZoomMode="Disabled" IsTabStop="False"
                                  IsDeferredScrollingEnabled="False">
                        <ListView
                            x:Name="CommandListView"
                            ItemsSource="{x:Bind FilteredCommands, Mode=OneWay}"
                            SelectionChanged="CommandListView_SelectionChanged"
                            SelectionMode="Single"
                            Background="Transparent"
                            BorderThickness="0"
                            IsItemClickEnabled="True"
                            HorizontalContentAlignment="Stretch"
                            Padding="4">
                            <ListView.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <ItemsStackPanel ItemsUpdatingScrollMode="KeepLastItemInView" 
                                                    Orientation="Vertical"/>
                                </ItemsPanelTemplate>
                            </ListView.ItemsPanel>
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="2" />
                                    <Setter Property="Margin" Value="0,2" />
                                </Style>
                            </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:CommandItem">
                                    <Grid Margin="0,2" Padding="12" Background="{ThemeResource ButtonBackground}" BorderBrush="{ThemeResource ButtonBorderBrush}" BorderThickness="1" CornerRadius="4" MinHeight="70">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock 
                                            Grid.Row="0" 
                                            Text="{x:Bind Name}" 
                                            FontWeight="SemiBold" 
                                            FontSize="14" 
                                            TextTrimming="CharacterEllipsis" />
                                        
                                        <TextBlock 
                                            Grid.Row="1" 
                                            Text="{x:Bind Description}" 
                                            TextWrapping="Wrap" 
                                            TextTrimming="CharacterEllipsis"
                                            FontSize="12" 
                                            Foreground="{ThemeResource TextFillColorSecondary}" 
                                            Margin="0,4,0,0"
                                            VerticalAlignment="Top" />
                                    </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </ScrollViewer>
                </Border>
            </Grid>
            
            <!-- 右侧面板：命令详情和执行区域 -->
            <Grid x:Name="RightPanelContainer" Grid.Column="1" Grid.Row="0" Grid.RowSpan="2"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  Margin="0,0,12,0">
                <Grid x:Name="RightPanel" MinWidth="300" HorizontalAlignment="Stretch" MaxWidth="1200">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <!-- 命令详情 -->
                    <Grid 
                        x:Name="CommandDetailPanel"
                        Grid.Row="0"
                        Visibility="{x:Bind HasSelectedCommand, Mode=OneWay}"
                        Margin="0,0,0,16"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16,12"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Top">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        
                        <TextBlock 
                            Grid.Row="0" 
                            Text="{x:Bind SelectedCommand.Name, Mode=OneWay}" 
                            FontSize="20" 
                            FontWeight="SemiBold"
                            TextWrapping="Wrap" />
                        
                        <TextBlock 
                            Grid.Row="1" 
                            Text="{x:Bind SelectedCommand.Description, Mode=OneWay}" 
                            TextWrapping="Wrap" 
                            Foreground="{ThemeResource TextFillColorSecondary}"
                            Margin="0,8,0,16" />
                        
                        <TextBox 
                            x:Name="CommandTextBox"
                            Grid.Row="2"
                            Text="{x:Bind SelectedCommand.Command, Mode=OneWay}" 
                            IsReadOnly="True" 
                            TextWrapping="Wrap"
                            FontFamily="Consolas"
                            Margin="0,0,0,16"
                            Padding="12,8"
                            CornerRadius="4"
                            BorderThickness="1"
                            BorderBrush="{ThemeResource TextControlBorderBrush}"
                            Background="{ThemeResource TextControlBackground}" 
                            HorizontalAlignment="Stretch" />
                        
                        <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="8">
                            <Button 
                                Style="{StaticResource ModernButtonStyle}"
                                Click="CopyCommand_Click">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE8C8;" />
                                    <TextBlock Text="复制命令" />
                                </StackPanel>
                            </Button>
                            
                            <Button 
                                Style="{StaticResource ActionButtonStyle}"
                                Click="RunSelectedCommand_Click"
                                IsEnabled="{x:Bind IsCommandRunning, Mode=OneWay, Converter={StaticResource BooleanNegationConverter}}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE768;" />
                                    <TextBlock Text="运行命令" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>
                    
                    <!-- 命令输入区域 -->
                    <Grid Grid.Row="1" Margin="0,0,0,16" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="8" Padding="16,12" HorizontalAlignment="Stretch" VerticalAlignment="Top">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <TextBox 
                            x:Name="CommandInputTextBox" 
                            Grid.Column="0"
                            PlaceholderText="输入自定义命令..." 
                            KeyDown="CommandInputTextBox_KeyDown"
                            FontFamily="Consolas"
                            Padding="12,8"
                            CornerRadius="4"
                            BorderThickness="1"
                            BorderBrush="{ThemeResource TextControlBorderBrush}" />
                        
                        <Button 
                            Grid.Column="1"
                            Style="{StaticResource ActionButtonStyle}"
                            Click="ExecuteCommand_Click" 
                            IsEnabled="{x:Bind IsCommandRunning, Mode=OneWay, Converter={StaticResource BooleanNegationConverter}}"
                            Margin="12,0,0,0">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <FontIcon Glyph="&#xE768;" />
                                <TextBlock Text="执行" />
                            </StackPanel>
                        </Button>
                    </Grid>
                    
                    <!-- 命令输出区域 -->
                    <Grid Grid.Row="2" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="8" Padding="0" HorizontalAlignment="Stretch" MinHeight="200" VerticalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        
                        <!-- 命令输出头部 -->
                        <Grid Grid.Row="0" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock 
                                Grid.Column="0"
                                Text="命令输出" 
                                FontWeight="SemiBold" 
                                FontSize="16"
                                VerticalAlignment="Center" />
                            
                            <Button 
                                Grid.Column="1"
                                Click="ClearOutput_Click"
                                Style="{StaticResource ModernButtonStyle}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE74D;" />
                                    <TextBlock Text="清空" />
                                </StackPanel>
                            </Button>
                        </Grid>
                        
                        <!-- 命令输出内容 -->
                        <ScrollViewer 
                            Grid.Row="1" 
                            VerticalScrollBarVisibility="Visible" 
                            HorizontalScrollBarVisibility="Disabled"
                            VerticalScrollMode="Enabled"
                            HorizontalScrollMode="Disabled"
                            ZoomMode="Disabled"
                            IsTabStop="False"
                            IsDeferredScrollingEnabled="True"
                            Padding="16,16,20,16"
                            Margin="0,0,0,0">
                            <TextBlock 
                                x:Name="CommandOutputText"
                                Text="{x:Bind CommandOutput, Mode=OneWay}" 
                                FontFamily="Consolas"
                                FontSize="14"
                                LineHeight="20"
                                TextWrapping="Wrap" />
                        </ScrollViewer>
                        
                        <!-- 命令输出底部 -->
                        <Grid Grid.Row="2" Padding="16,12" BorderThickness="0,1,0,0" BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <ProgressRing 
                                    IsActive="{x:Bind IsCommandRunning, Mode=OneWay}" 
                                    Width="20" 
                                    Height="20" />
                                
                                <TextBlock 
                                    Text="命令执行中..." 
                                    Visibility="{x:Bind IsCommandRunning, Mode=OneWay}" 
                                    VerticalAlignment="Center" />
                            </StackPanel>
                            
                            <muxc:InfoBar
                                Grid.Column="1"
                                x:Name="ExecutionInfoBar"
                                IsOpen="False" 
                                Severity="Success"
                                Title="命令执行成功"
                                Message=""
                                IsClosable="True"
                                HorizontalAlignment="Center" />
                                
                            <Button 
                                Grid.Column="2"
                                Click="CopyOutput_Click"
                                Visibility="{x:Bind CommandOutput, Mode=OneWay, Converter={StaticResource StringToVisibilityConverter}}"
                                Style="{StaticResource ModernButtonStyle}"
                                HorizontalAlignment="Right">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE8C8;" />
                                    <TextBlock Text="复制输出" />
            </StackPanel>
                            </Button>
                        </Grid>
                    </Grid>
                </Grid>
            </Grid>
        </Grid>
        
        <!-- 提示气泡 -->
        <muxc:TeachingTip
            x:Name="CopiedTip"
            Title="已复制"
            Subtitle="内容已复制到剪贴板"
            PlacementMargin="20"
            IsLightDismissEnabled="True"
            PreferredPlacement="Bottom">
        </muxc:TeachingTip>
    </Grid>
</Page>